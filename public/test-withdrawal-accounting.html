<!DOCTYPE html>
<html>
<head>
    <title>Test Withdrawal API with Accounting Integration</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; white-space: pre-wrap; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        input, select, textarea { width: 100%; margin: 5px 0; padding: 8px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üè¶ Test Withdrawal API with Accounting Integration</h1>
    
    <div class="info">
        <strong>Features Being Tested:</strong><br>
        ‚úÖ Partner equity balance validation<br>
        ‚úÖ Journal entries creation (Debit: Partner Equity, Credit: Cash)<br>
        ‚úÖ Account balance updates<br>
        ‚úÖ Redux user authentication integration<br>
        ‚úÖ Detailed accounting feedback
    </div>

    <div class="container">
        <h3>1. Test Withdrawal with Accounting</h3>
        <input type="text" id="partnerId" placeholder="Partner ID (UUID)" />
        <input type="number" id="amount" placeholder="Withdrawal Amount" step="0.01" />
        <select id="category">
            <option value="salary">Salary</option>
            <option value="dividend">Dividend</option>
            <option value="capital_withdrawal">Capital Withdrawal</option>
            <option value="other">Other</option>
        </select>
        <textarea id="description" placeholder="Description (optional)"></textarea>
        <input type="text" id="userId" placeholder="User ID (from Redux - use admin ID for testing)" />
        <button onclick="testWithdrawal()">Process Withdrawal</button>
        <div id="withdrawalResult" class="result"></div>
    </div>

    <div class="container">
        <h3>2. Check Partner Balance</h3>
        <input type="text" id="checkPartnerId" placeholder="Partner ID to check balance" />
        <button onclick="checkPartnerBalance()">Check Balance</button>
        <div id="balanceResult" class="result"></div>
    </div>

    <div class="container">
        <h3>3. Get Partner List (for reference)</h3>
        <button onclick="getPartners()">Get All Partners</button>
        <div id="partnersResult" class="result"></div>
    </div>

    <script>
        async function testWithdrawal() {
            const partnerId = document.getElementById('partnerId').value;
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const userId = document.getElementById('userId').value;
            
            if (!partnerId || !amount || !userId) {
                showResult('withdrawalResult', 'error', 'Please fill in Partner ID, Amount, and User ID');
                return;
            }

            try {
                const response = await fetch('/api/equity/withdrawals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        partner_id: partnerId,
                        amount: parseFloat(amount),
                        category: category,
                        description: description,
                        created_by: userId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('withdrawalResult', 'success', 
                        `‚úÖ Withdrawal Successful!\n\n` +
                        `Partner: ${data.data.partner_id}\n` +
                        `Amount: ‚Çπ${data.data.amount.toLocaleString()}\n` +
                        `Category: ${data.data.category}\n\n` +
                        `üè¶ Accounting Details:\n` +
                        `Partner Account: ${data.accounting.partner_account}\n` +
                        `Previous Balance: ‚Çπ${data.accounting.previous_balance.toLocaleString()}\n` +
                        `Withdrawal Amount: ‚Çπ${data.accounting.withdrawal_amount.toLocaleString()}\n` +
                        `New Balance: ‚Çπ${data.accounting.new_balance.toLocaleString()}\n\n` +
                        `Message: ${data.message}`
                    );
                } else {
                    showResult('withdrawalResult', 'error', `‚ùå ${data.error}`);
                }
            } catch (error) {
                showResult('withdrawalResult', 'error', `Network Error: ${error.message}`);
            }
        }

        async function checkPartnerBalance() {
            const partnerId = document.getElementById('checkPartnerId').value;
            if (!partnerId) {
                showResult('balanceResult', 'error', 'Please enter Partner ID');
                return;
            }

            try {
                const accountCode = `3015-${partnerId}`;
                const response = await fetch(`/api/finance/chart-of-accounts?account_code=${accountCode}`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    const account = data.data[0];
                    showResult('balanceResult', 'success', 
                        `üè¶ Partner Equity Account Details:\n\n` +
                        `Account Code: ${account.account_code}\n` +
                        `Account Name: ${account.account_name}\n` +
                        `Current Balance: ‚Çπ${parseFloat(account.current_balance || 0).toLocaleString()}\n` +
                        `Account Type: ${account.account_type}\n` +
                        `Last Updated: ${new Date(account.updated_at).toLocaleDateString()}`
                    );
                } else {
                    showResult('balanceResult', 'error', `‚ùå Partner equity account not found. Partner may not have made any investments yet.`);
                }
            } catch (error) {
                showResult('balanceResult', 'error', `Network Error: ${error.message}`);
            }
        }

        async function getPartners() {
            try {
                const response = await fetch('/api/equity/investors');
                const data = await response.json();
                
                if (data.success) {
                    const partnersInfo = data.data.map(partner => 
                        `ID: ${partner.id}\nName: ${partner.name}\nEmail: ${partner.email || 'N/A'}\nInvestment: ‚Çπ${parseFloat(partner.investment_amount || 0).toLocaleString()}`
                    ).join('\n\n');
                    
                    showResult('partnersResult', 'success', `üìã All Partners:\n\n${partnersInfo}`);
                } else {
                    showResult('partnersResult', 'error', `‚ùå ${data.error}`);
                }
            } catch (error) {
                showResult('partnersResult', 'error', `Network Error: ${error.message}`);
            }
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
        }

        // Set default user ID (admin user ID from database)
        document.getElementById('userId').value = '550e8400-e29b-41d4-a716-446655440000';
    </script>
</body>
</html>